<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Трекер навыков</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #2481cc;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f1f1f1;
            
            --primary: var(--tg-theme-text-color);
            --secondary: var(--tg-theme-hint-color);
            --background: var(--tg-theme-bg-color);
            --surface: var(--tg-theme-bg-color);
            --border: #e8e8ed;
            --hover: var(--tg-theme-secondary-bg-color);
            --accent: var(--tg-theme-button-color);
            --accent-hover: #1e6ba8;
            --accent-light: rgba(36, 129, 204, 0.1);
            --success: #34c759;
            --success-light: #d1f2d9;
            --success-glow: #22c55e;
            --muted: #e3e3e6;
            --danger: #ff3b30;
            --radius: 12px;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-hover: 0 4px 16px rgba(0,0,0,0.1);
            --shadow-modal: 0 20px 40px rgba(0,0,0,0.15);
            --row-even: rgba(0,0,0,0.02);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 16px;
            line-height: 1.5;
            color: var(--primary);
            background: var(--background);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }
        
        /* Mobile styles (default) */
        .mobile-view {
            display: block;
        }
        
        .desktop-view {
            display: none;
        }
        
        /* Container styles */
        .container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--surface);
        }
        
        /* Mobile Header */
        .header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 16px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .date-display {
            text-align: center;
            margin-bottom: 12px;
        }
        
        .date-display h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .date-display p {
            font-size: 14px;
            color: var(--secondary);
        }
        
        .nav-buttons {
            display: flex;
            gap: 8px;
        }
        
        .nav-button {
            flex: 1;
            padding: 10px;
            border: none;
            background: var(--hover);
            color: var(--primary);
            font-size: 14px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .nav-button:active {
            transform: scale(0.98);
            background: var(--accent-light);
        }
        
        /* Mobile Skills List */
        .skills-list {
            flex: 1;
            padding: 16px;
            padding-bottom: 80px;
        }
        
        .skill-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 12px;
            overflow: hidden;
            transition: all 0.2s ease;
        }
        
        .skill-card.completed {
            border-color: var(--success);
            background: var(--success-light);
        }
        
        .skill-header {
            padding: 16px;
            cursor: pointer;
            user-select: none;
        }
        
        .skill-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        
        .skill-name {
            font-weight: 600;
            font-size: 16px;
            flex: 1;
        }
        
        .skill-score {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--hover);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.2s ease;
        }
        
        .skill-score.filled {
            background: var(--accent);
            color: white;
        }
        
        .skill-score.high {
            background: var(--success);
            color: white;
        }
        
        .skill-category {
            font-size: 14px;
            color: var(--secondary);
        }
        
        .skill-actions {
            padding: 0 16px 16px;
            display: flex;
            gap: 8px;
        }
        
        .action-button {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--primary);
            font-size: 14px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            text-align: center;
        }
        
        .action-button:active {
            transform: scale(0.98);
            background: var(--hover);
        }
        
        .action-button.primary {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        /* Desktop styles */
        .desktop-container {
            max-width: 1600px;
            margin: 20px auto;
            background: var(--surface);
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.06);
            overflow: hidden;
        }
        
        .desktop-toolbar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
        }
        
        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .toolbar-separator {
            width: 1px;
            height: 24px;
            background: var(--border);
            margin: 0 8px;
        }
        
        .desktop-button {
            padding: 10px 18px;
            border: none;
            background: var(--hover);
            color: var(--primary);
            font-size: 14px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            font-family: inherit;
        }
        
        .desktop-button:hover {
            background: #e5e5e7;
            transform: translateY(-1px);
        }
        
        .desktop-button:active {
            transform: translateY(0);
        }
        
        .desktop-button.primary {
            background: var(--accent);
            color: white;
        }
        
        .desktop-button.primary:hover {
            background: var(--accent-hover);
        }
        
        .desktop-button.danger {
            background: rgba(255,59,48,0.1);
            color: var(--danger);
        }
        
        .date-input {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }
        
        .date-input label {
            font-size: 14px;
            color: var(--secondary);
            font-weight: 500;
        }
        
        .date-input input {
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--surface);
            transition: all 0.2s ease;
            font-family: inherit;
            color: var(--primary);
        }
        
        .date-input input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(36,129,204,0.1);
        }
        
        /* Desktop Table */
        .table-wrapper {
            overflow: auto;
            position: relative;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        
        th, td {
            border: none;
            border-right: 1px solid var(--border);
            text-align: center;
            height: 48px;
            padding: 0;
        }
        
        tr td:last-child,
        tr th:last-child {
            border-right: none;
        }
        
        tbody tr:nth-child(even) {
            background-color: var(--row-even);
        }
        
        tbody tr {
            transition: background-color 0.2s ease;
        }
        
        tbody tr:hover {
            background-color: var(--hover);
        }
        
        th {
            background: var(--surface);
            font-weight: 600;
            font-size: 12px;
            color: var(--secondary);
            position: sticky;
            top: 0;
            z-index: 10;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border);
        }
        
        th.skill-header {
            width: 250px;
            text-align: left;
            padding: 0 20px;
            background: var(--surface);
            position: sticky;
            left: 0;
            z-index: 11;
            border-right: 2px solid var(--border);
            color: var(--accent);
        }
        
        .date-header {
            font-size: 11px;
            line-height: 1.3;
            padding: 4px;
        }
        
        .weekend {
            background-color: rgba(36,129,204,0.03) !important;
        }
        
        tbody tr:nth-child(even) .weekend {
            background-color: rgba(36,129,204,0.05) !important;
        }
        
        th.current-day {
            background: linear-gradient(180deg, var(--accent) 4px, var(--surface) 4px) !important;
            box-shadow: inset 0 3px 0 var(--accent);
        }
        
        td.skill-cell {
            text-align: left;
            padding: 0 20px;
            background: inherit;
            position: sticky;
            left: 0;
            z-index: 9;
            border-right: 2px solid var(--border);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .skill-number {
            flex-shrink: 0;
            color: var(--secondary);
            font-weight: 500;
            font-size: 14px;
        }
        
        .skill-name-text {
            flex: 1;
            line-height: 1.3;
        }
        
        tbody tr:nth-child(even) td.skill-cell {
            background: var(--row-even);
        }
        
        tbody tr:hover td.skill-cell {
            background: var(--hover);
        }
        
        td.skill-cell:hover {
            padding-left: 24px;
        }
        
        .day-cell {
            cursor: pointer;
            position: relative;
            transition: all 0.15s ease;
            width: 48px;
            min-width: 48px;
        }
        
        .day-cell:hover {
            background: var(--accent-light) !important;
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 5;
            border-radius: 4px;
        }
        
        .day-cell.checked {
            background: var(--success-light) !important;
        }
        
        .day-cell.checked .score {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
        }
        
        .day-cell.score-0,
        .day-cell.score-1,
        .day-cell.score-2,
        .day-cell.score-3,
        .day-cell.score-4 {
            background: var(--muted) !important;
        }
        
        .day-cell.score-5 {
            background: var(--success-light) !important;
        }
        
        .day-cell.score-6,
        .day-cell.score-7 {
            background: var(--success-light) !important;
        }
        
        .day-cell.score-7 {
            animation: glow 2s ease-in-out infinite;
            position: relative;
        }
        
        @keyframes glow {
            0%, 100% { 
                box-shadow: 0 0 15px rgba(34,197,94,0.6), 
                            inset 0 0 10px rgba(34,197,94,0.2); 
            }
            50% { 
                box-shadow: 0 0 25px rgba(34,197,94,0.8), 
                            inset 0 0 15px rgba(34,197,94,0.3); 
            }
        }
        
        .comment-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: flex-end;
            justify-content: center;
            padding: 0;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: var(--surface);
            width: 100%;
            max-height: 80vh;
            border-radius: 16px 16px 0 0;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }
        
        .modal-drag-handle {
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            flex: 1;
        }
        
        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 24px;
            color: var(--secondary);
        }
        
        .modal-close:active {
            background: var(--hover);
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
        }
        
        .modal-button {
            flex: 1;
            padding: 14px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }
        
        .modal-button.cancel {
            background: var(--hover);
            color: var(--primary);
        }
        
        .modal-button.save {
            background: var(--accent);
            color: white;
        }
        
        .modal-button:active {
            transform: scale(0.98);
        }
        
        /* Score Grid */
        .score-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .score-button {
            padding: 20px 12px;
            border: 2px solid var(--border);
            background: var(--surface);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .score-button:active {
            transform: scale(0.95);
        }
        
        .score-button.selected {
            border-color: var(--accent);
            background: var(--accent-light);
        }
        
        .score-number {
            font-size: 24px;
            font-weight: 700;
            display: block;
            margin-bottom: 4px;
        }
        
        .score-label {
            font-size: 11px;
            color: var(--secondary);
            line-height: 1.2;
        }
        
        /* Score selector for desktop */
        .score-selector {
            display: none;
            position: absolute;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            z-index: 100;
            overflow: hidden;
            animation: scoreSlideIn 0.2s ease;
        }
        
        @keyframes scoreSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .score-option {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 13px;
            border-bottom: 1px solid var(--hover);
        }
        
        .score-option:last-child {
            border-bottom: none;
        }
        
        .score-option:hover {
            background: var(--hover);
        }
        
        /* Comment styles */
        .skill-comment {
            padding: 0 16px 16px;
            font-size: 14px;
            color: var(--secondary);
            font-style: italic;
        }
        
        .comment-form {
            margin-top: 20px;
        }
        
        .comment-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--secondary);
        }
        
        .comment-input {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            background: var(--surface);
            color: var(--primary);
        }
        
        .comment-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        /* Form styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--secondary);
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--surface);
            font-family: inherit;
            transition: all 0.2s ease;
            color: var(--primary);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(36,129,204,0.1);
        }
        
        /* Stats styles */
        .stats-container {
            padding: 20px;
        }
        
        .stat-card {
            background: var(--hover);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .stat-title {
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
        }
        
        .stat-description {
            font-size: 14px;
            color: var(--secondary);
            margin-top: 4px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        
        /* Help styles */
        .help-section {
            margin-bottom: 24px;
        }
        
        .help-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary);
        }
        
        .help-text {
            font-size: 14px;
            line-height: 1.6;
            color: var(--secondary);
            margin-bottom: 8px;
        }
        
        .score-legend {
            background: var(--hover);
            border-radius: 8px;
            padding: 12px;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .score-legend-item {
            display: flex;
            align-items: baseline;
            margin-bottom: 4px;
        }
        
        .score-legend-number {
            font-weight: 600;
            width: 20px;
        }
        
        /* Skill list styles */
        .skill-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
        }
        
        .skill-item {
            padding: 16px 20px;
            border-bottom: 1px solid var(--hover);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .skill-item:last-child {
            border-bottom: none;
        }
        
        .skill-item:hover {
            background: var(--hover);
        }
        
        .skill-info {
            flex: 1;
        }
        
        .skill-info-name {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .skill-category-small {
            font-size: 12px;
            color: var(--secondary);
            opacity: 0.7;
        }
        
        .skill-actions-desktop {
            display: flex;
            gap: 6px;
        }
        
        .skill-actions-desktop button {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        /* Info sections */
        .info-section {
            margin-bottom: 24px;
        }
        
        .info-section h3 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .info-text {
            font-size: 14px;
            line-height: 1.6;
            color: var(--secondary);
            margin-bottom: 12px;
        }
        
        .score-list {
            font-size: 13px;
            line-height: 1.8;
        }
        
        .score-list strong {
            display: inline-block;
            width: 24px;
        }
        
        /* Tooltip */
        .tooltip {
            position: absolute;
            background: var(--primary);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 300px;
        }
        
        .tooltip.show {
            opacity: 0.95;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--secondary);
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }
        
        .empty-text {
            font-size: 16px;
        }
        
        /* Dark theme adjustments */
        @media (prefers-color-scheme: dark) {
            :root {
                --row-even: rgba(255,255,255,0.02);
                --border: rgba(255,255,255,0.1);
                --hover: rgba(255,255,255,0.05);
            }
        }
        
        /* Desktop modal adjustments */
        @media (min-width: 768px) {
            .modal-content {
                max-width: 500px;
                max-height: 85vh;
                border-radius: 16px;
                margin: auto;
            }
            
            .modal {
                align-items: center;
                padding: 20px;
            }
            
            .modal-drag-handle {
                display: none;
            }
        }
        
        /* Responsive breakpoint */
        @media (min-width: 768px) {
            .mobile-view {
                display: none;
            }
            
            .desktop-view {
                display: block;
            }
            
            body {
                font-size: 14px;
                padding: 0;
                background: #f5f5f7;
            }
        }
        
        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-size: 16px;
            color: var(--secondary);
        }
        
        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Mobile View -->
    <div class="mobile-view">
        <div class="container">
            <div class="header">
                <div class="date-display">
                    <h1 id="currentDate">Сегодня</h1>
                    <p id="currentDateFull"></p>
                </div>
                <div class="nav-buttons">
                    <button class="nav-button" onclick="showSkillManager()">
                        <span>📋</span>
                        <span>Навыки</span>
                    </button>
                    <button class="nav-button" onclick="showStats()">
                        <span>📊</span>
                        <span>Стат</span>
                    </button>
                    <button class="nav-button" onclick="showHelp()">
                        <span>❓</span>
                        <span>Справка</span>
                    </button>
                    <button class="nav-button" onclick="toggleView()">
                        <span>💻</span>
                        <span>Версия</span>
                    </button>
                </div>
                <div class="nav-buttons" style="margin-top: 8px;">
    <button class="nav-button" onclick="exportData()">
        <span>💾</span>
        <span>Экспорт</span>
    </button>
    <button class="nav-button" onclick="document.getElementById('importFileMobile').click()">
        <span>📂</span>
        <span>Импорт</span>
    </button>
    <button class="nav-button" onclick="syncFromFirebase()">
        <span>☁️</span>
        <span>Синхр.</span>
    </button>
</div>
<div class="nav-buttons" style="margin-top: 8px;">
    <button class="nav-button" onclick="forceSync()">
        <span>⬇️</span>
        <span>Загрузить</span>
    </button>
    <button class="nav-button" onclick="showFirebaseStatus()">
        <span>🔧</span>
        <span>Firebase</span>
    </button>
</div>
                <input type="file" id="importFileMobile" accept=".json" onchange="importData(event)" style="display: none;">
            </div>
            
            <div class="skills-list" id="skillsList"></div>
        </div>
    </div>
    
    <!-- Desktop View -->
    <div class="desktop-view">
        <div class="desktop-container">
            <div class="desktop-toolbar">
                <div class="toolbar-group">
                    <button class="desktop-button" onclick="showSkillManager()">Управление навыками</button>
                    <button class="desktop-button" onclick="exportData()">Экспорт</button>
                    <button class="desktop-button" onclick="document.getElementById('importFile').click()">Импорт</button>
                    <button class="desktop-button primary" onclick="syncFromFirebase()">☁️ Синхронизация</button>
                    <input type="file" id="importFile" accept=".json" onchange="importData(event)">
                </div>
                
                <div class="toolbar-separator"></div>
                
                <div class="toolbar-group">
                    <button class="desktop-button" onclick="showInstructions()">Инструкция</button>
                    <button class="desktop-button" onclick="showStats()">Стат.</button>
                    <button class="desktop-button danger" onclick="clearData()">Очистить</button>
                </div>
                
                <div class="date-input">
                    <label>Начало отслеживания:</label>
                    <input type="date" id="startDate" onchange="updateDates()">
                </div>
            </div>
            
            <div class="table-wrapper">
                <table id="skillsTable">
                    <thead>
                        <tr>
                            <th class="skill-header">Навык</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-drag-handle"></div>
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle"></h2>
                <button class="modal-close" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>
    
    <div id="scoreSelector" class="score-selector"></div>
    <div id="tooltip" class="tooltip"></div>
    
    <script>
        // Initialize Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAgIA0PLvUOJsRN8tHRzC03evTTkt3KHHc",
            authDomain: "skills-tracker-3f21b.firebaseapp.com",
            projectId: "skills-tracker-3f21b",
            storageBucket: "skills-tracker-3f21b.firebasestorage.app",
            messagingSenderId: "108202530564",
            appId: "1:108202530564:web:31ecf70071f49a89abe251"
        };
        
        // Initialize Firebase
        let db = null;
        let firebaseAuth = null;
        let firebaseUser = null;
        let firebaseEnabled = false;
        let syncInProgress = false;
        let cloudStorageEnabled = false;

        // Заглушка для отсутствующей функции
        function syncFromCloud() {
            console.log('Cloud sync not implemented');
        }
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            firebaseAuth = firebase.auth();
            
            // Sign in anonymously
            firebaseAuth.signInAnonymously()
                .then((result) => {
                    firebaseUser = result.user;
                    firebaseEnabled = true;
                    console.log('Firebase initialized successfully');
                    // Sync on startup
                    syncFromFirebase();
                })
                .catch((error) => {
    console.error('Firebase auth error:', error);
    firebaseEnabled = false;
    // Показывать уведомление только один раз
    if (!window.firebaseErrorShown) {
        window.firebaseErrorShown = true;
        showSyncNotification('Firebase недоступен. Работа в локальном режиме.');
    }
});
        } catch (error) {
            console.error('Firebase initialization error:', error);
            firebaseEnabled = false;
            showSyncNotification('Ошибка инициализации Firebase');
        }
        
        // Set higher API version for Cloud Storage support
        if (tg.version < '6.9') {
            console.warn('Cloud Storage requires Telegram WebApp version 6.9 or higher. Current version:', tg.version);
        }
        
        // Apply Telegram theme
        if (tg.themeParams) {
            const root = document.documentElement;
            const params = tg.themeParams;
            
            if (params.bg_color) root.style.setProperty('--tg-theme-bg-color', params.bg_color);
            if (params.text_color) root.style.setProperty('--tg-theme-text-color', params.text_color);
            if (params.hint_color) root.style.setProperty('--tg-theme-hint-color', params.hint_color);
            if (params.link_color) root.style.setProperty('--tg-theme-link-color', params.link_color);
            if (params.button_color) root.style.setProperty('--tg-theme-button-color', params.button_color);
            if (params.button_text_color) root.style.setProperty('--tg-theme-button-text-color', params.button_text_color);
            if (params.secondary_bg_color) root.style.setProperty('--tg-theme-secondary-bg-color', params.secondary_bg_color);
        }
      

// Storage
        const userId = tg.initDataUnsafe?.user?.id || 'anonymous';
        const storagePrefix = `tg_skills_${userId}_`;

  // Функция для безопасного хеширования      
function simpleHash(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return 'user_' + Math.abs(hash).toString();
}

// Создаем безопасный ID для Firebase
const userIdentifier = tg.initDataUnsafe?.user?.username || 
                      tg.initDataUnsafe?.user?.id || 
                      'anonymous';
const firebaseSecureId = simpleHash(userIdentifier.toString());
console.log('Firebase Secure ID:', firebaseSecureId); // Для отладки
        
                
        // Default skills
        let skills = [
            {
                id: 1,
                name: "Не поддаваться импульсам",
                category: "Контроль импульсов",
                description: "Способность воздерживаться от нежелательных реакций",
                instruction: ""
            },
            {
                id: 2,
                name: "Мышечная релаксация",
                category: "Физиологическая стабилизация",
                description: "Техника Джейкобсона: последовательное напряжение и расслабление мышц",
                instruction: "Сжать-расслабить группы мышц сверху вниз (2 минуты)"
            },
            {
                id: 3,
                name: "Вопрос «Мне это эффективно?»",
                category: "Когнитивная гибкость",
                description: "Оценка пользы текущего поведения или мыслительной стратегии",
                instruction: "Задавать после короткой паузы, когда эмоциональный уровень ≤ 6 из 10"
            },
            {
                id: 4,
                name: "ПРОСИ-коммуникация",
                category: "Коммуникация",
                description: "Эффективная стратегия межличностного взаимодействия",
                instruction: "5 шагов: Проговорить факты → Раскрыть чувства → Отстоять позицию → Сообщить выгоду → Игнорировать лишнее"
            },
            {
                id: 5,
                name: "СТОП-пауза",
                category: "Контроль импульсов",
                description: "Техника остановки при всплеске эмоций",
                instruction: "Стоп → Шаг назад → Наблюдай → Действуй осознанно. Медленный вдох, сказать «стоп», замереть на 2 секунды"
            },
            {
                id: 6,
                name: "Переключение внимания",
                category: "Осознанность",
                description: "Фокусировка на конкретных стимулах",
                instruction: "Якорение на звук/дыхание ветра"
            },
            {
                id: 7,
                name: "Экстренный холод к лицу",
                category: "Физиологическая стабилизация",
                description: "Быстрое снижение эмоционального напряжения",
                instruction: "Умыть лицо холодной водой 10 секунд. Применять при напряжении > 7/10"
            },
            {
                id: 8,
                name: "Безоценочность",
                category: "Когнитивная гибкость",
                description: "Принятие мыслей без оценки как фактов",
                instruction: "Поймать «ярлык», заменить на «я думаю, что…». Помнить: мысль ≠ факт"
            },
            {
                id: 9,
                name: "Описание переживания словами",
                category: "Осознанность",
                description: "Вербализация текущих состояний",
                instruction: "Проговаривать: «Это страх… это критик…»"
            },
            {
                id: 10,
                name: "Бланк «За и против»",
                category: "Принятие решений",
                description: "Систематизация информации для принятия решений",
                instruction: "4 столбца, выбрать действие с ≥2 плюсами и ≤1 критичным минусом"
            },
            {
                id: 11,
                name: "Выписывать мысли",
                category: "Работа с мыслями",
                description: "Структурирование и анализ мыслей",
                instruction: "10-минутный поток, затем перечитать, подчёркивая факты/домыслы"
            },
            {
                id: 12,
                name: "Принятие ситуации",
                category: "Принятие и сострадание",
                description: "Наблюдение за переживаниями без сопротивления",
                instruction: "Визуализировать чувство на «облаке», представить, как оно проплывает. Применять при остаточном волнении 3-5/10"
            },
            {
                id: 13,
                name: "Навык сострадания",
                category: "Принятие и сострадание",
                description: "Проявление доброты к себе",
                instruction: "Положить ладонь на грудь, сделать «пол-улыбки», сказать «я молодец, что пытаюсь». Применять после ошибки/критики"
            }
        ];
        
        const scoreDescriptions = [
            "Не думал(а) о навыке",
            "Думал(а), не хотел(а) применять",
            "Хотел(а), но не применил(а)",
            "Старался(ась), не смог(ла)",
            "Применил(а), не помогло",
            "Применил(а), помогло",
            "Автоматически, не помогло",
            "Автоматически, помогло"
        ];
        
        let data = {};
        let comments = {};
        let startDate = '';
        let currentEditingSkill = null;
        let longPressTimer;
        let isLongPress = false;
        
        // Check if mobile
        function isMobile() {
            return window.innerWidth < 768;
        }
        
        function loadData() {
            const savedSkills = localStorage.getItem(storagePrefix + 'skills');
            const savedData = localStorage.getItem(storagePrefix + 'data');
            const savedComments = localStorage.getItem(storagePrefix + 'comments');
            const savedStartDate = localStorage.getItem(storagePrefix + 'startDate');
            
            if (savedSkills) {
                skills = JSON.parse(savedSkills);
            }
            if (savedData) {
                data = JSON.parse(savedData);
            }
            if (savedComments) {
                comments = JSON.parse(savedComments);
            }
            if (savedStartDate) {
                startDate = savedStartDate;
            } else {
                startDate = new Date().toISOString().split('T')[0];
            }
        }
        function saveData() {
    localStorage.setItem(storagePrefix + 'skills', JSON.stringify(skills));
    localStorage.setItem(storagePrefix + 'data', JSON.stringify(data));
    localStorage.setItem(storagePrefix + 'comments', JSON.stringify(comments));
    localStorage.setItem(storagePrefix + 'startDate', startDate);
    
    if (tg.HapticFeedback) {
        tg.HapticFeedback.impactOccurred('light');
    }
    
    // Sync to Firebase if available
    if (firebaseEnabled && firebaseUser && !syncInProgress) {
        syncToFirebase();
    }
}
       
       // Firebase sync functions
       function syncToFirebase() {
           if (!firebaseEnabled || !firebaseUser || syncInProgress) return;
           
           syncInProgress = true;
           const userData = {
               skills: skills,
               data: data,
               comments: comments,
               startDate: startDate,
               lastSync: firebase.firestore.FieldValue.serverTimestamp(),
               telegramId: userId,
               version: '3.2'
           };
           
           db.collection('users').doc(firebaseSecureId).collection('data').doc('tracker')
               .set(userData)
               .then(() => {
                   syncInProgress = false;
                   console.log('Synced to Firebase');
               })
               .catch((error) => {
                   syncInProgress = false;
                   console.error('Firebase sync error:', error);
               });
       }
       
       function syncFromFirebase() {
           if (!firebaseEnabled || !firebaseUser || syncInProgress) {
               if (!firebaseEnabled) {
                   showSyncNotification('Firebase недоступен');
               }
               return;
           }
           
           syncInProgress = true;
           showSyncNotification('Синхронизация...');
           
           db.collection('users').doc(firebaseSecureId).collection('data').doc('tracker')
               .get()
               .then((doc) => {
                   syncInProgress = false;
                   
                   if (doc.exists) {
                       const firebaseData = doc.data();
                       
                       // Check if Firebase data is newer
                       const localLastSync = localStorage.getItem(storagePrefix + 'lastFirebaseSync');
                       const firebaseLastSync = firebaseData.lastSync?.toDate?.() || new Date(0);
                       
                       if (!localLastSync || firebaseLastSync > new Date(localLastSync)) {
                           if (firebaseData.skills) skills = firebaseData.skills;
                           if (firebaseData.data) data = firebaseData.data;
                           if (firebaseData.comments) comments = firebaseData.comments;
                           if (firebaseData.startDate) startDate = firebaseData.startDate;
                           
                           localStorage.setItem(storagePrefix + 'skills', JSON.stringify(skills));
                           localStorage.setItem(storagePrefix + 'data', JSON.stringify(data));
                           localStorage.setItem(storagePrefix + 'comments', JSON.stringify(comments));
                           localStorage.setItem(storagePrefix + 'startDate', startDate);
                           localStorage.setItem(storagePrefix + 'lastFirebaseSync', firebaseLastSync.toISOString());
                           
                           showSyncNotification('Данные обновлены из облака');
                           
                           if (isMobile()) {
                               renderSkills();
                           } else {
                               updateDates();
                           }
                       } else {
                           showSyncNotification('Локальные данные актуальны');
                       }
                   } else {
                       showSyncNotification('Создание облачного хранилища...');
                       syncToFirebase();
                   }
               })
               .catch((error) => {
                   syncInProgress = false;
                   console.error('Firebase sync error:', error);
                   showSyncNotification('Ошибка синхронизации');
               });
       }
       
    
       let notificationTimeout = null;
let lastNotificationMessage = '';

function showSyncNotification(message) {
    // Не показывать одинаковые сообщения подряд
    if (message === lastNotificationMessage) return;
    lastNotificationMessage = message;
    
    // Отменить предыдущее уведомление
    if (notificationTimeout) {
        clearTimeout(notificationTimeout);
    }
    
    // Удалить существующее уведомление
    const existingNotification = document.querySelector('.sync-notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    const notification = document.createElement('div');
    notification.className = 'sync-notification';
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--primary);
        color: var(--surface);
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 10000;
        animation: slideDown 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    notificationTimeout = setTimeout(() => {
        notification.style.animation = 'slideUp 0.3s ease';
        setTimeout(() => {
            notification.remove();
            lastNotificationMessage = '';
        }, 300);
    }, 2000);
}
       
       // Add animation styles
       const style = document.createElement('style');
       style.textContent = `
           @keyframes slideDown {
               from { transform: translate(-50%, -100%); opacity: 0; }
               to { transform: translate(-50%, 0); opacity: 1; }
           }
           @keyframes slideUp {
               from { transform: translate(-50%, 0); opacity: 1; }
               to { transform: translate(-50%, -100%); opacity: 0; }
           }
       `;
       document.head.appendChild(style);
       
       function getTodayKey() {
           const today = new Date();
           return `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
       }
       
       function getDateKey(date) {
           return `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;
       }
       
       function getDayFromStart(date) {
           const start = new Date(startDate);
           const diffTime = Math.abs(date - start);
           const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
           return diffDays;
       }
       
       function init() {
    loadData();
        
    if (isMobile()) {
        updateDateDisplay();
        renderSkills();
    } else {
        document.getElementById('startDate').value = startDate;
        updateDates();
    }
}
// Toggle between mobile and desktop view
function toggleView() {
    const isMobileView = document.querySelector('.mobile-view').style.display !== 'none';
    if (isMobileView) {
        document.querySelector('.mobile-view').style.display = 'none';
        document.querySelector('.desktop-view').style.display = 'block';
        document.getElementById('startDate').value = startDate;
        updateDates();
    } else {
        document.querySelector('.mobile-view').style.display = 'block';
        document.querySelector('.desktop-view').style.display = 'none';
        updateDateDisplay();
        renderSkills();
    }
}
                  
       // Mobile functions
       function updateDateDisplay() {
           const today = new Date();
           const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
           document.getElementById('currentDateFull').textContent = today.toLocaleDateString('ru', options);
       }
       
       function renderSkills() {
           const container = document.getElementById('skillsList');
           const todayKey = getTodayKey();
           
           if (skills.length === 0) {
               container.innerHTML = `
                   <div class="empty-state">
                       <div class="empty-icon">📝</div>
                       <div class="empty-text">Нет навыков для отслеживания</div>
                   </div>
               `;
               return;
           }
           
           container.innerHTML = skills.map((skill, index) => {
               const key = `${todayKey}-${skill.id}`;
               const score = data[key];
               const comment = comments[key];
               const hasScore = score !== undefined;
               const isHigh = score >= 5;
               
               return `
                   <div class="skill-card ${hasScore ? 'completed' : ''}" data-skill-id="${skill.id}">
                       <div class="skill-header" onclick="toggleSkillActions(${skill.id})">
                           <div class="skill-title">
                              <div>
    <div class="skill-name">${index + 1}. ${skill.name}</div>
    <div class="skill-category" style="font-size: 13px; line-height: 1.4; margin-top: 4px;">
        ${skill.description}
        ${skill.instruction ? `<br><em style="color: var(--accent);">Инструкция: ${skill.instruction}</em>` : ''}
    </div>
</div>
                               <div class="skill-score ${hasScore ? (isHigh ? 'high' : 'filled') : ''}">
                                   ${hasScore ? score : '—'}
                               </div>
                           </div>
                       </div>
                       ${comment ? `<div class="skill-comment">${comment}</div>` : ''}
                       <div class="skill-actions" id="actions-${skill.id}" style="display: none;">
                           <button class="action-button primary" onclick="showScoreModal(${skill.id})">
                               ${hasScore ? 'Изменить оценку' : 'Оценить'}
                           </button>
                           <button class="action-button" onclick="showCommentModal(${skill.id})">
                               ${comment ? 'Изменить' : 'Добавить'} комментарий
                           </button>
                       </div>
                   </div>
               `;
           }).join('');
       }
       
       function toggleSkillActions(skillId) {
           const actions = document.getElementById(`actions-${skillId}`);
           const isVisible = actions.style.display !== 'none';
           
           // Hide all other actions
           document.querySelectorAll('.skill-actions').forEach(el => {
               el.style.display = 'none';
           });
           
           // Toggle current
           actions.style.display = isVisible ? 'none' : 'flex';
           
           if (!isVisible && tg.HapticFeedback) {
               tg.HapticFeedback.impactOccurred('light');
           }
       }
       
       // Desktop functions
       function updateDates() {
           startDate = document.getElementById('startDate').value;
           saveData();
           
           const table = document.getElementById('skillsTable');
           const thead = table.querySelector('thead tr');
           const tbody = table.querySelector('tbody');
           
           // Clear existing
           while (thead.children.length > 1) {
               thead.removeChild(thead.lastChild);
           }
           tbody.innerHTML = '';
           
           // Create date headers
           const start = new Date(startDate);
           start.setHours(0, 0, 0, 0);
           const today = new Date();
           today.setHours(0, 0, 0, 0);
           
           for (let i = 0; i < 30; i++) {
               const date = new Date(start);
               date.setDate(start.getDate() + i);
               date.setHours(0, 0, 0, 0);
               
               const th = document.createElement('th');
               th.className = 'date-header';
               
               const dayOfWeek = date.getDay();
               if (dayOfWeek === 0 || dayOfWeek === 6) {
                   th.classList.add('weekend');
               }
               
               if (date.toDateString() === today.toDateString()) {
                   th.classList.add('current-day');
               }
               
               th.innerHTML = `${date.getDate()}<br>${date.toLocaleDateString('ru', {month: 'short'})}`;
               thead.appendChild(th);
           }
           
           // Create skill rows
           skills.forEach((skill, index) => {
               const tr = document.createElement('tr');
               
               const skillCell = document.createElement('td');
               skillCell.className = 'skill-cell';
               skillCell.innerHTML = `<span class="skill-number">${index + 1}.</span><span class="skill-name-text">${skill.name}</span>`;
               skillCell.title = skill.category;
               skillCell.onclick = () => showSkillDetails(skill);
               tr.appendChild(skillCell);
               
               for (let day = 0; day < 30; day++) {
                   const date = new Date(start);
                   date.setDate(start.getDate() + day);
                   const dayOfWeek = date.getDay();
                   
                   const td = document.createElement('td');
                   td.className = 'day-cell';
                   
                   if (dayOfWeek === 0 || dayOfWeek === 6) {
                       td.classList.add('weekend');
                   }
                   
                   td.dataset.skillId = skill.id;
                   td.dataset.day = day;
                   
                   const dateKey = getDateKey(date);
                   const key = `${dateKey}-${skill.id}`;
                   
                   if (data[key] !== undefined) {
                       td.classList.add('checked');
                       if (typeof data[key] === 'number') {
                           td.classList.add(`score-${data[key]}`);
                           td.innerHTML = `<div class="score">${data[key]}</div>`;
                       }
                       
                       if (comments[key]) {
                           const indicator = document.createElement('div');
                           indicator.className = 'comment-indicator';
                           td.appendChild(indicator);
                       }
                   }
                   
                   td.onclick = (e) => toggleCell(e, skill.id, date);
                   td.oncontextmenu = (e) => {
                       e.preventDefault();
                       showScoreSelector(e, skill.id, date);
                   };
                   
                   td.onmouseenter = (e) => showTooltip(e, skill.id, date);
                   td.onmouseleave = hideTooltip;
                   
                   tr.appendChild(td);
               }
               
               tbody.appendChild(tr);
           });
       }
       
       function toggleCell(e, skillId, date) {
           const cell = e.target.closest('.day-cell');
           const dateKey = getDateKey(date);
           const key = `${dateKey}-${skillId}`;
           
           if (data[key] !== undefined) {
               delete data[key];
               cell.classList.remove('checked');
               cell.classList.remove(...Array.from(cell.classList).filter(c => c.startsWith('score-')));
               cell.innerHTML = '';
           } else {
               data[key] = true;
               cell.classList.add('checked');
           }
           
           saveData();
       }
       
       function showScoreSelector(e, skillId, date) {
           const selector = document.getElementById('scoreSelector');
           selector.innerHTML = '';
           selector.style.display = 'block';
           selector.style.left = e.pageX + 'px';
           selector.style.top = e.pageY + 'px';
           
           scoreDescriptions.forEach((desc, score) => {
               const option = document.createElement('div');
               option.className = 'score-option';
               option.textContent = `${score}: ${desc}`;
               option.onclick = () => setScoreDesktop(skillId, date, score);
               selector.appendChild(option);
           });
           
           const commentOption = document.createElement('div');
           commentOption.className = 'score-option';
           commentOption.style.borderTop = '2px solid var(--border)';
           commentOption.innerHTML = '<strong>Добавить комментарий...</strong>';
           commentOption.onclick = () => {
               closeScoreSelector();
               showCommentModalDesktop(skillId, date);
           };
           selector.appendChild(commentOption);
           
           setTimeout(() => {
               document.addEventListener('click', closeScoreSelector);
           }, 0);
       }
       
       function closeScoreSelector() {
           document.getElementById('scoreSelector').style.display = 'none';
           document.removeEventListener('click', closeScoreSelector);
       }
       
       function setScoreDesktop(skillId, date, score) {
           const dateKey = getDateKey(date);
           const key = `${dateKey}-${skillId}`;
           const dayNum = getDayFromStart(date);
           const cell = document.querySelector(`[data-skill-id="${skillId}"][data-day="${dayNum}"]`);
           
           data[key] = score;
           cell.classList.add('checked');
           cell.classList.remove(...Array.from(cell.classList).filter(c => c.startsWith('score-')));
           cell.classList.add(`score-${score}`);
           cell.innerHTML = `<div class="score">${score}</div>`;
           
           if (comments[key]) {
               const indicator = document.createElement('div');
               indicator.className = 'comment-indicator';
               cell.appendChild(indicator);
           }
           
           saveData();
           closeScoreSelector();
       }
       
       function showTooltip(e, skillId, date) {
           const dateKey = getDateKey(date);
           const key = `${dateKey}-${skillId}`;
           if (comments[key]) {
               const tooltip = document.getElementById('tooltip');
               tooltip.textContent = comments[key];
               tooltip.style.left = e.pageX + 10 + 'px';
               tooltip.style.top = e.pageY + 10 + 'px';
               tooltip.classList.add('show');
           }
       }
       
       function hideTooltip() {
           const tooltip = document.getElementById('tooltip');
           tooltip.classList.remove('show');
       }
       
       // Modal functions
       function showScoreModal(skillId) {
           const skill = skills.find(s => s.id === skillId);
           const todayKey = getTodayKey();
           const key = `${todayKey}-${skillId}`;
           const currentScore = data[key];
           
           currentEditingSkill = { id: skillId, date: new Date() };
           
           const content = `
               <div class="score-grid">
                   ${scoreDescriptions.map((desc, index) => `
                       <div class="score-button ${currentScore === index ? 'selected' : ''}" 
                            onclick="selectScore(${index})">
                           <span class="score-number">${index}</span>
                           <span class="score-label">${desc}</span>
                       </div>
                   `).join('')}
               </div>
           `;
           
           const footer = `
               <button class="modal-button cancel" onclick="closeModal()">Отмена</button>
               <button class="modal-button save" onclick="saveScore()">Сохранить</button>
           `;
           
           showModal(`Оценка: ${skill.name}`, content, footer);
       }
       
       function showCommentModal(skillId) {
           const skill = skills.find(s => s.id === skillId);
           const todayKey = getTodayKey();
           const key = `${todayKey}-${skillId}`;
           const currentComment = comments[key] || '';
           
           currentEditingSkill = { id: skillId, date: new Date() };
           
           const content = `
               <div class="comment-form">
                   <label class="comment-label">Комментарий к применению навыка</label>
                   <textarea class="comment-input" id="commentInput" 
                             placeholder="Опишите, как применили навык...">${currentComment}</textarea>
               </div>
           `;
           
           const footer = `
               <button class="modal-button cancel" onclick="closeModal()">Отмена</button>
               <button class="modal-button save" onclick="saveComment()">Сохранить</button>
           `;
           
           showModal(`Комментарий: ${skill.name}`, content, footer);
           
           setTimeout(() => {
               document.getElementById('commentInput').focus();
           }, 300);
       }
       
       function showCommentModalDesktop(skillId, date) {
           const skill = skills.find(s => s.id === skillId);
           const dateKey = getDateKey(date);
           const key = `${dateKey}-${skillId}`;
           const currentComment = comments[key] || '';
           
           currentEditingSkill = { id: skillId, date: date };
           
           const content = `
               <div class="form-group">
                   <label>Комментарий к применению навыка</label>
                   <textarea id="commentInput" placeholder="Опишите, как применили навык...">${currentComment}</textarea>
               </div>
           `;
           
           const footer = `
               <button class="modal-button cancel" onclick="closeModal()">Отмена</button>
               <button class="modal-button save" onclick="saveComment()">Сохранить</button>
           `;
           
           showModal(`${skill.name} - ${date.toLocaleDateString('ru')}`, content, footer);
       }
       
       function selectScore(score) {
           document.querySelectorAll('.score-button').forEach((btn, index) => {
               btn.classList.toggle('selected', index === score);
           });
           
           window.tempScore = score;
           
           if (tg.HapticFeedback) {
               tg.HapticFeedback.selectionChanged();
           }
       }
       
       function saveScore() {
           if (window.tempScore === undefined) {
               tg.showAlert('Выберите оценку');
               return;
           }
           
           const dateKey = getDateKey(currentEditingSkill.date);
           const key = `${dateKey}-${currentEditingSkill.id}`;
           
           data[key] = window.tempScore;
           saveData();
           
           window.tempScore = undefined;
           currentEditingSkill = null;
           
           closeModal();
           
           if (isMobile()) {
               renderSkills();
           } else {
               updateDates();
           }
       }
       
       function saveComment() {
           const commentText = document.getElementById('commentInput').value.trim();
           const dateKey = getDateKey(currentEditingSkill.date);
           const key = `${dateKey}-${currentEditingSkill.id}`;
           
           if (commentText) {
               comments[key] = commentText;
           } else {
               delete comments[key];
           }
           
           saveData();
           currentEditingSkill = null;
           closeModal();
           
           if (isMobile()) {
               renderSkills();
           } else {
               updateDates();
           }
       }
       
       function showSkillDetails(skill) {
           const content = `
               <div class="info-section">
                   <h3>Категория</h3>
                   <p class="info-text">${skill.category}</p>
               </div>
               <div class="info-section">
                   <h3>Описание</h3>
                   <p class="info-text">${skill.description}</p>
               </div>
               ${skill.instruction ? `
               <div class="info-section">
                   <h3>Инструкция</h3>
                   <p class="info-text">${skill.instruction}</p>
               </div>
               ` : ''}
           `;
           showModal(skill.name, content);
       }
       
       function showSkillManager() {
           const content = `
               <button class="${isMobile() ? 'action-button' : 'desktop-button'} primary" 
                       onclick="showAddSkill()" style="width: 100%; margin-bottom: 16px;">
                   Добавить навык
               </button>
               <div class="skill-list">
                   ${skills.map((skill, index) => `
                       <div class="skill-item">
                           <div class="skill-info" style="display: flex; align-items: flex-start; gap: 8px;">
                               <span style="flex-shrink: 0; font-weight: 500;">${index + 1}.</span>
                               <div style="flex: 1;">
                                   <div class="skill-info-name">${skill.name}</div>
                                   <div class="skill-category-small">${skill.category}</div>
                               </div>
                           </div>
                           <div class="skill-actions-desktop">
                               <button class="${isMobile() ? 'action-button' : 'desktop-button'}" 
                                       onclick="editSkill(${skill.id})">Изменить</button>
                               <button class="${isMobile() ? 'action-button' : 'desktop-button'} danger" 
                                       onclick="deleteSkill(${skill.id})">Удалить</button>
                           </div>
                       </div>
                   `).join('')}
               </div>
           `;
           showModal('Управление навыками', content);
       }
       
       function showAddSkill() {
           const content = `
               <form id="skillForm">
                   <div class="form-group">
                       <label>Название навыка</label>
                       <input type="text" id="skillName" required>
                   </div>
                   <div class="form-group">
                       <label>Категория</label>
                       <input type="text" id="skillCategory" required>
                   </div>
                   <div class="form-group">
                       <label>Описание</label>
                       <textarea id="skillDescription" required></textarea>
                   </div>
                   <div class="form-group">
                       <label>Инструкция (необязательно)</label>
                       <textarea id="skillInstruction"></textarea>
                   </div>
               </form>
           `;
           
           const footer = `
               <button class="modal-button cancel" onclick="closeModal()">Отмена</button>
               <button class="modal-button save" onclick="saveNewSkill()">Сохранить</button>
           `;
           
           showModal('Добавить навык', content, footer);
       }
       
       function saveNewSkill() {
           const name = document.getElementById('skillName').value.trim();
           const category = document.getElementById('skillCategory').value.trim();
           const description = document.getElementById('skillDescription').value.trim();
           const instruction = document.getElementById('skillInstruction').value.trim();
           
           if (!name || !category || !description) {
               tg.showAlert('Заполните все обязательные поля');
               return;
           }
           
           const newSkill = {
               id: Date.now(),
               name,
               category,
               description,
               instruction
           };
           
           skills.push(newSkill);
           saveData();
           closeModal();
           
           if (isMobile()) {
               renderSkills();
           } else {
               updateDates();
           }
       }
        function editSkill(id) {
           const skill = skills.find(s => s.id === id);
           if (!skill) return;
           
           const content = `
               <form id="skillForm">
                   <div class="form-group">
                       <label>Название навыка</label>
                       <input type="text" id="skillName" value="${skill.name}" required>
                   </div>
                   <div class="form-group">
                       <label>Категория</label>
                       <input type="text" id="skillCategory" value="${skill.category}" required>
                   </div>
                   <div class="form-group">
                       <label>Описание</label>
                       <textarea id="skillDescription" required>${skill.description}</textarea>
                   </div>
                   <div class="form-group">
                       <label>Инструкция (необязательно)</label>
                       <textarea id="skillInstruction">${skill.instruction || ''}</textarea>
                   </div>
               </form>
           `;
           
           const footer = `
               <button class="modal-button cancel" onclick="closeModal()">Отмена</button>
               <button class="modal-button save" onclick="updateSkill(${id})">Сохранить</button>
           `;
           
           showModal('Редактировать навык', content, footer);
       }
       
       function updateSkill(id) {
           const skill = skills.find(s => s.id === id);
           if (!skill) return;
           
           skill.name = document.getElementById('skillName').value.trim();
           skill.category = document.getElementById('skillCategory').value.trim();
           skill.description = document.getElementById('skillDescription').value.trim();
           skill.instruction = document.getElementById('skillInstruction').value.trim();
           
           if (!skill.name || !skill.category || !skill.description) {
               tg.showAlert('Заполните все обязательные поля');
               return;
           }
           
           saveData();
           closeModal();
           
           if (isMobile()) {
               renderSkills();
           } else {
               updateDates();
           }
       }
       
       function deleteSkill(id) {
           if (isMobile()) {
               tg.showConfirm('Удалить этот навык? Все данные по нему будут потеряны.', (confirmed) => {
                   if (!confirmed) return;
                   performDeleteSkill(id);
               });
           } else {
               if (!confirm('Удалить этот навык? Все данные по нему будут потеряны.')) return;
               performDeleteSkill(id);
           }
       }
       
       function performDeleteSkill(id) {
           skills = skills.filter(s => s.id !== id);
           
           const newData = {};
           const newComments = {};
           for (let key in data) {
               if (!key.includes(`-${id}`)) {
                   newData[key] = data[key];
               }
           }
           for (let key in comments) {
               if (!key.includes(`-${id}`)) {
                   newComments[key] = comments[key];
               }
           }
           data = newData;
           comments = newComments;
           
           saveData();
           closeModal();
           
           if (isMobile()) {
               renderSkills();
           } else {
               updateDates();
           }
       }
       
       function showStats() {
           const stats = skills.map(skill => {
               let totalDays = 0;
               let totalScore = 0;
               let daysWithScore = 0;
               let highScoreDays = 0;
               const dailyScores = [];
               
               for (let i = 0; i < 30; i++) {
                   const date = new Date();
                   date.setDate(date.getDate() - i);
                   const dateKey = getDateKey(date);
                   const key = `${dateKey}-${skill.id}`;
                   
                   if (data[key] !== undefined) {
                       totalDays++;
                       if (typeof data[key] === 'number') {
                           totalScore += data[key];
                           daysWithScore++;
                           dailyScores.push(data[key]);
                           if (data[key] >= 5) highScoreDays++;
                       }
                   }
               }
               
               return {
                   name: skill.name,
                   category: skill.category,
                   totalDays,
                   avgScore: daysWithScore > 0 ? (totalScore / daysWithScore).toFixed(1) : '-',
                   highScoreDays,
                   trend: dailyScores.length > 1 ? 
                       (dailyScores[0] > dailyScores[dailyScores.length - 1] ? '↑' : '→') : ''
               };
           }).sort((a, b) => b.totalDays - a.totalDays);
           
           const content = `
               <div class="stats-container">
                   <div class="stats-grid">
                       ${stats.map(stat => `
                           <div class="stat-card">
                               <h4>${stat.name}</h4>
                               <p>Категория: ${stat.category}</p>
                               <p>Использован: ${stat.totalDays} раз</p>
                               ${stat.avgScore !== '-' ? `<p>Средняя оценка: ${stat.avgScore} ${stat.trend}</p>` : ''}
                               ${stat.highScoreDays > 0 ? `<p>Эффективно: ${stat.highScoreDays} раз</p>` : ''}
                           </div>
                       `).join('')}
                   </div>
               </div>
           `;
           
           showModal('Статистика за 30 дней', content);
       }
       
       function showHelp() {
           const content = `
               <div class="help-section">
                   <h3 class="help-title">Как пользоваться</h3>
                   <p class="help-text">1. ${isMobile() ? 'Нажмите на навык' : 'Кликните на ячейку дня'} для отметки применения</p>
                   <p class="help-text">2. ${isMobile() ? 'Выберите "Оценить"' : 'Правый клик'} для выбора оценки (0-7)</p>
                   <p class="help-text">3. Добавьте комментарий при необходимости</p>
               </div>
               
               <div class="help-section">
                   <h3 class="help-title">Шкала оценок</h3>
                   <div class="score-legend">
                       ${scoreDescriptions.map((desc, index) => `
                           <div class="score-legend-item">
                               <span class="score-legend-number">${index}:</span> ${desc}
                           </div>
                       `).join('')}
                   </div>
               </div>
               
               <div class="help-section">
                   <h3 class="help-title">Цветовая индикация</h3>
                   <p class="help-text">🔴 Серый (0-4) — навык требует работы</p>
                   <p class="help-text">🟢 Зеленый (5-7) — навык помог</p>
                   <p class="help-text">✨ Свечение (7) — полный автоматизм</p>
               </div>
               
               <div class="help-section">
                   <h3 class="help-title">Синхронизация между устройствами</h3>
                   <p class="help-text">☁️ <strong>Облачная синхронизация:</strong> Автоматическое сохранение в Firebase</p>
                   <p class="help-text">💾 <strong>Экспорт:</strong> Скачать все данные в JSON файл</p>
                   <p class="help-text">📂 <strong>Импорт:</strong> Загрузить данные из JSON файла</p>
                   <p class="help-text">🔄 Данные синхронизируются между всеми вашими устройствами автоматически</p>
               </div>
               <div class="help-section">
               <h3 class="help-title">Ваш ID синхронизации</h3>
               <p class="help-text">Secure ID: ${firebaseSecureId}</p>
               </div>
           `;
           
           showModal('Справка', content);
       }
       
       function showInstructions() {
           showHelp();
       }
       
       function exportData() {
           const exportObj = {
               skills: skills,
               data: data,
               comments: comments,
               startDate: startDate,
               exportDate: new Date().toISOString(),
               version: '3.1'
           };
           
           const dataStr = JSON.stringify(exportObj, null, 2);
           
           if (isMobile()) {
               // Для мобильных устройств показываем данные в модальном окне
               const content = `
                   <div class="form-group">
                       <label>Скопируйте данные и сохраните в заметки или отправьте себе:</label>
                       <textarea 
                           id="exportTextarea" 
                           class="comment-input" 
                           style="min-height: 300px; font-family: monospace; font-size: 12px;"
                           readonly
                       >${dataStr}</textarea>
                   </div>
                   <button class="action-button primary" onclick="copyExportData()" style="width: 100%; margin-top: 12px;">
                       📋 Копировать в буфер обмена
                   </button>
               `;
               
               showModal('Экспорт данных', content);
               
               // Автоматически выделяем текст
               setTimeout(() => {
                   const textarea = document.getElementById('exportTextarea');
                   if (textarea) {
                       textarea.select();
                       textarea.setSelectionRange(0, 99999); // Для мобильных
                   }
               }, 100);
           } else {
               // Для десктопа стандартная загрузка
               const dataBlob = new Blob([dataStr], {type: 'application/json'});
               const url = URL.createObjectURL(dataBlob);
               const link = document.createElement('a');
               link.href = url;
               link.download = `skills-tracker-${new Date().toISOString().split('T')[0]}.json`;
               link.click();
               URL.revokeObjectURL(url);
           }
       }
       
       function copyExportData() {
           const textarea = document.getElementById('exportTextarea');
           if (textarea) {
               textarea.select();
               textarea.setSelectionRange(0, 99999);
               
               try {
                   document.execCommand('copy');
                   showSyncNotification('Данные скопированы в буфер обмена');
                   
                   // Закрываем модальное окно через секунду
                   setTimeout(() => {
                       closeModal();
                   }, 1000);
               } catch (err) {
                   // Если не удалось скопировать автоматически
                   if (navigator.clipboard && navigator.clipboard.writeText) {
                       navigator.clipboard.writeText(textarea.value)
                           .then(() => {
                               showSyncNotification('Данные скопированы в буфер обмена');
                               setTimeout(() => {
                                   closeModal();
                               }, 1000);
                           })
                           .catch(() => {
                               showSyncNotification('Выделите текст и скопируйте вручную');
                           });
                   } else {
                       showSyncNotification('Выделите текст и скопируйте вручную');
                   }
               }
           }
       }
       
       function importData(event) {
           const file = event.target.files[0];
           if (!file) return;
           
           const reader = new FileReader();
           reader.onload = function(e) {
               try {
                   const importedData = JSON.parse(e.target.result);
                   
                   const confirmImport = () => {
                       if (importedData.skills) skills = importedData.skills;
                       if (importedData.data) data = importedData.data;
                       if (importedData.comments) comments = importedData.comments;
                       if (importedData.startDate) startDate = importedData.startDate;
                       
                       saveData();
                       location.reload();
                   };
                   
                   if (isMobile()) {
                       tg.showConfirm('Это заменит все текущие данные. Продолжить?', (confirmed) => {
                           if (confirmed) confirmImport();
                       });
                   } else {
                       if (confirm('Это заменит все текущие данные. Продолжить?')) {
                           confirmImport();
                       }
                   }
               } catch (error) {
                   if (isMobile()) {
                       tg.showAlert('Ошибка при чтении файла');
                   } else {
                       alert('Ошибка при чтении файла');
                   }
               }
           };
           reader.readAsText(file);
           
           // Clear the input so the same file can be selected again
           event.target.value = '';
       }
       
       function clearData() {
           if (confirm('Удалить все данные? Это действие необратимо!')) {
               if (confirm('Вы точно уверены? Все отметки и комментарии будут потеряны!')) {
                   data = {};
                   comments = {};
                   saveData();
                   updateDates();
               }
           }
       }
       
       function showModal(title, content, footer = '') {
           document.getElementById('modalTitle').textContent = title;
           document.getElementById('modalBody').innerHTML = content;
           document.getElementById('modalFooter').innerHTML = footer;
           document.getElementById('modalFooter').style.display = footer ? 'flex' : 'none';
           document.getElementById('modal').classList.add('show');
           
           if (tg.BackButton) {
               tg.BackButton.show();
               tg.BackButton.onClick(closeModal);
           }
       }
       
       function closeModal() {
           document.getElementById('modal').classList.remove('show');
           
           if (tg.BackButton) {
               tg.BackButton.hide();
           }
           
           window.tempScore = undefined;
           currentEditingSkill = null;
       }
       
       
       // Modal swipe to close (mobile only)
       if (isMobile()) {
           let touchStartY = 0;
           let modalContent = null;
           
           document.addEventListener('touchstart', (e) => {
               modalContent = e.target.closest('.modal-content');
               if (modalContent) {
                   touchStartY = e.touches[0].clientY;
               }
           });
           
           document.addEventListener('touchmove', (e) => {
               if (modalContent) {
                   const touchY = e.touches[0].clientY;
                   const diff = touchY - touchStartY;
                   if (diff > 0) {
                       modalContent.style.transform = `translateY(${diff}px)`;
                   }
               }
           });
           
           document.addEventListener('touchend', (e) => {
               if (modalContent) {
                   const touchEndY = e.changedTouches[0].clientY;
                   const diff = touchEndY - touchStartY;
                   
                   if (diff > 100) {
                       closeModal();
                   } else {
                       modalContent.style.transform = 'translateY(0)';
                   }
                   
                   modalContent = null;
               }
           });
       }
       
       // Click outside to close
       document.getElementById('modal').addEventListener('click', (e) => {
           if (e.target.id === 'modal') {
               closeModal();
           }
       });
       function showFirebaseStatus() {
    const content = `
        <div class="info-section">
            <h3>Статус Firebase</h3>
            <p class="info-text"><strong>User ID:</strong> ${userId}</p>
            <p class="info-text"><strong>Firebase ID:</strong> ${firebaseSecureId}</p>
            <p class="info-text"><strong>Firebase включен:</strong> ${firebaseEnabled ? 'Да' : 'Нет'}</p>
            <p class="info-text"><strong>Firebase User:</strong> ${firebaseUser ? firebaseUser.uid : 'Нет'}</p>
            <p class="info-text"><strong>Есть локальные данные:</strong> ${Object.keys(data).length > 0 ? 'Да' : 'Нет'}</p>
        </div>
        <button class="action-button primary" onclick="forceSyncFromFirebase()" style="width: 100%; margin-top: 16px;">
            Принудительно загрузить из облака
        </button>
    `;
    showModal('Firebase Status', content);
}

function forceSyncFromFirebase() {
    // Очищаем локальные данные
    data = {};
    comments = {};
    skills = [];
    localStorage.removeItem(storagePrefix + 'lastFirebaseSync');
    
    // Загружаем из Firebase
    syncFromFirebase();
    closeModal();
}

function forceSync() {
    if (confirm('Загрузить все данные из облака? Локальные изменения будут перезаписаны.')) {
        // Очищаем только данные, но не весь localStorage
        data = {};
        comments = {};
        skills = [];
        localStorage.removeItem(storagePrefix + 'skills');
        localStorage.removeItem(storagePrefix + 'data');
        localStorage.removeItem(storagePrefix + 'comments');
        localStorage.removeItem(storagePrefix + 'lastFirebaseSync');
        
        // Перезагружаем
        location.reload();
    }
}
       // Initialize
       init();
       
       // Theme change handler
       tg.onEvent('themeChanged', () => {
           location.reload();
       });
       
       // Window resize handler
       let resizeTimer;
       window.addEventListener('resize', () => {
           clearTimeout(resizeTimer);
           resizeTimer = setTimeout(() => {
               const wasMobile = document.querySelector('.mobile-view').style.display !== 'none';
               const isNowMobile = window.innerWidth < 768;
               
               if (wasMobile !== isNowMobile) {
                   location.reload();
               }
           }, 250);
       });
   </script>
</body>
</html>
